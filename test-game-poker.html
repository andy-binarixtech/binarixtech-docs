<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>POKER GAME</title>

  <style>
    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 20px;
    }
    .card-item {
      border: 1px solid #666;
      border-radius: 6px;
      padding: 10px;
      width: 120px;
      text-align: center;
      background: #f9f9f9;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    .card-sprite {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 6px;
    }
    .card-info {
      font-size: 13px;
      color: #333;
    }
  </style>

  <style>
    .player-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px;
      margin: 10px;
      width: 280px;
      display: inline-block;
      text-align: center;
      background: #f9f9f9;
    }
    .player-card img {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
    }
    .player-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .player-info {
      font-size: 14px;
      color: #333;
      margin-bottom: 10px;
    }
    .player-hand {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .card {
      border: 1px solid #666;
      border-radius: 4px;
      padding: 4px;
      background: #fff;
      font-size: 12px;
    }
  </style>

  <style>
    #log {
      font-family: monospace;
      border: 1px solid #ccc;
      padding: 8px;
      max-height: 300px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .log-entry {
      display: block;
      border-bottom: 1px solid #eee;
      padding: 4px 0;
      align-items: center;
    }
    .log-time {
      width: 200px;
      color: #888;
      font-weight: bold;
    }
    .log-msg {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .log-msg.sent {
      color: green;
    }
    .log-msg.received {
      color: blue;
    }
    .log-msg.error {
      color: red;
    }
    .log-icon {
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <h2>Sicbo WebSocket Client</h2>
  <div style="padding: 10px;">
    <button onclick="connect()">Connect</button>
    <button onclick="login()">Login</button>
    <button onclick="get_room_types()">get room types</button>
    <button onclick="search_room()">search room</button>
    <button onclick="create_room()">create room</button>
    <button onclick="join_room(G_ROOM_ID)">Join Room</button>
    <button onclick="ping()">PING</button>
  </div>

  <div id="controls" style="padding: 10px;">
    <button id="clearBtn">üßπ Clear Log</button>
  </div>


  <div>
    <span>User Id: </span>
    <span id='userId'></span>
  </div>
  <div>
    <span>Group Id: </span>
    <span id='groupId'></span>
    <div id="group-id-button-container"></div>
  </div>
  <div>
    <span>Room Id: </span>
    <span id='roomId'></span>
  </div>
  <div id="players-container"></div>
  <div id="table-container"></div>
  <pre id="log"></pre>

  <script>
    let socket;
    let G_USER_ID
    let G_GROUP_ID;
    let G_ROOM_ID;
    let G_PLAYER_INFOS = [];
    let G_TABLE_CARDS = [];
    const zoneName = 'SicboZone';
    const pluginName = 'pokerGame';

    function logNative(msg) {
      const timestamp = new Date().toISOString();
      document.getElementById("log").textContent += timestamp + " : " + msg + "\n";
    }

    function log(msg, type="default") {
      const timestamp = new Date().toLocaleString();
      const logContainer = document.getElementById("log");

      const entry = document.createElement("div");
      entry.className = "log-entry";

      const timeCol = document.createElement("div");
      timeCol.className = "log-time";
      timeCol.textContent = timestamp;

      const actionCol = document.createElement("div");
      actionCol.className = "log-action";

      const btnFormat = document.createElement("button");
      btnFormat.textContent = "Toggle JSON";
      btnFormat.onclick = () => toogleFormatJson(btnFormat);

      const btnCopy = document.createElement("button");
      btnCopy.textContent = "Copy";
      btnCopy.onclick = () => copyJsonData(btnCopy);

      const msgCol = document.createElement("div");
      msgCol.className = "log-msg " + type;

      const icon = document.createElement("span");
      icon.className = "log-icon";

      // ch·ªçn icon theo lo·∫°i log
      switch(type) {
        case "sent": icon.textContent = "üì§"; break;
        case "received": icon.textContent = "üì•"; break;
        case "error": icon.textContent = "‚ö†Ô∏è"; break;
        default: icon.textContent = "‚ÑπÔ∏è";
      }

      const text = document.createElement("span");
      text.className = 'log-content';
      text.textContent = msg;

      msgCol.appendChild(icon);
      msgCol.appendChild(text);
      actionCol.appendChild(btnFormat);
      actionCol.appendChild(btnCopy);

      entry.appendChild(timeCol);
      entry.appendChild(actionCol);
      entry.appendChild(msgCol);
      logContainer.appendChild(entry);

      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function connect() {
      socket = new WebSocket("ws://localhost:8892/websocket");

      socket.onopen = () => {
        log("Connected to server");
        socket.send(JSON.stringify({ action: "join_to_poker_game" }));
      };

      socket.onmessage = (event) => {
        log(event.data);
        const response = event.data;
        const jsonResponse = JSON.parse(event.data);
        const idResponse = jsonResponse[0];
        if (idResponse === 1) {
          process_response_1(jsonResponse);
        } else if (idResponse === 3) {
          process_response_3(jsonResponse);
        } else if (idResponse === 5) {
          process_response_5(jsonResponse);
        }
      };

      socket.onclose = () => {
        log("Connection closed");
      };

      socket.onerror = (err) => {
        log("Error: " + err, "error");
      };
    }

    function process_response_5(jsonResponse) {
      const dataResponse = jsonResponse[1];
      const action = dataResponse?.action;
      const eventServer = dataResponse.event;
      if ( (action === 'search_room' && eventServer === 'room_info') 
          || (action === 'create_room' && eventServer === 'room_info') ) {
        const datas = dataResponse?.datas;
        const roomInfo = datas?.roomInfo;
        const roomId = roomInfo?.roomId;
        log("> room id: " + roomId);
        if (roomId) {
          join_room(roomId);
        }
      }
      if (action === 'get_room_types' && eventServer === 'room_types') {
        const datas = dataResponse?.datas;
        const roomTypes = datas?.roomTypes;
        if (roomTypes) {
          createButtonsFromJson(roomTypes);
          selectGroupId('POKER_2000');
        }
      }

      if (action === 'room_data' && eventServer === 'room_data') {
        const datas = dataResponse?.datas;
        const playerInfos = datas?.playerInfos;
        G_PLAYER_INFOS = playerInfos;
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }

      if (action === 'user_enter_room' && eventServer === 'user_enter_room') {
        const datas = dataResponse?.datas;
        const playerInfo = datas?.playerInfo;
        updatePlayerInfo(G_PLAYER_INFOS, playerInfo);
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }

      if (action === 'place_bind' && eventServer === 'place_bind') {
        const datas = dataResponse?.datas;
        const playerInfo = datas?.playerInfo;
        updatePlayerInfo(G_PLAYER_INFOS, playerInfo);
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }

      if (action === 'deal_hole_cards' && eventServer === 'deal_hole_cards') {
        const datas = dataResponse?.datas;
        const playerInfo = datas?.playerInfo;
        updatePlayerInfo(G_PLAYER_INFOS, playerInfo);
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }

      if (action === 'deal_flop' && eventServer === 'deal_flop') {
        const datas = dataResponse?.datas;
        const tableCards = datas?.dealTableCard?.tableCards;
        G_TABLE_CARDS = tableCards;
        console.log(tableCards);
        if (G_TABLE_CARDS) {
          showTableCards(G_TABLE_CARDS);
        }
      }

        if (action === 'deal_turn' && eventServer === 'deal_turn') {
        const datas = dataResponse?.datas;
        const tableCards = datas?.dealTableCard?.tableCards;
        G_TABLE_CARDS = G_TABLE_CARDS.concat(tableCards);
        console.log(G_TABLE_CARDS);
        if (G_TABLE_CARDS) {
          showTableCards(G_TABLE_CARDS);
        }
      }

        if (action === 'deal_river' && eventServer === 'deal_river') {
        const datas = dataResponse?.datas;
        const tableCards = datas?.dealTableCard?.tableCards;
        G_TABLE_CARDS = G_TABLE_CARDS.concat(tableCards);
        console.log(G_TABLE_CARDS);
        if (G_TABLE_CARDS) {
          showTableCards(G_TABLE_CARDS);
        }
      }

      if (action === 'user_exit_room' && eventServer === 'user_exit_room') {
        const datas = dataResponse?.datas;
        const playerInfo = datas?.playerInfo;
        removePlayerInfo(G_PLAYER_INFOS, playerInfo?.name);
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }
    }

    function process_response_1(jsonResponse) {
      const success = jsonResponse[1];
      const userId = jsonResponse[3];
      if (success) {
        G_USER_ID = userId;
        showUserId();
        log("> User login success: " + userId);
      }
    }

    function process_response_3(jsonResponse) {
      const success = jsonResponse[1];
      const roomId = jsonResponse[3];
      if (success) {
        G_ROOM_ID = roomId;
        showRoomId();
        log("> join room success: " + roomId);
      }
    }

    function login() {
      if (!isSocketConnected()) {
        return;
      }
      const userId = createUserId();
      const loginMessage = [
        1,
        zoneName,
        userId, 
        "pw_123", 
        {}
      ]

      const msg = loginMessage;
      socket.send(JSON.stringify(msg));
      log("Login message: " + JSON.stringify(msg));
    }

    function get_room_types() {
      if (!isSocketConnected()) {
        return;
      }
      const zonePluginMessage = [
        6,
        zoneName,
        pluginName,
        {
          "action": "get_room_types",
          "requestId": "test_123_abc",
          "payload": {}
        }
      ];
      const msg = zonePluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function search_room() {
      if (!G_GROUP_ID) {
        alert('Select group id, please');
        return;
      }
      if (!isSocketConnected()) {
        return;
      }
      const zonePluginMessage = [
        6,
        zoneName,
        pluginName,
        {
          "action": "search_room",
          "payload": {
              "groupId": G_GROUP_ID
          }
        }
      ];
      const msg = zonePluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function create_room() {
      if (!G_GROUP_ID) {
        alert('Select group id, please');
        return;
      }
      if (!isSocketConnected()) {
        return;
      }
      const zonePluginMessage = [
        6,
        zoneName,
        pluginName,
        {
          "action": "create_room",
          "payload": {
              "groupId": G_GROUP_ID
          }
        }
      ];
      const msg = zonePluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function join_room(roomId) {
      if (!roomId) {
        alert('Select room, please');
        return;
      }
      if (!isSocketConnected()) {
        return;
      }
      const joinRoomMessage = [
        3, 
        zoneName, 
        roomId, 
        ""
      ]
      const msg = joinRoomMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function ping() {
      if (!isSocketConnected()) {
        return;
      }
      const msg = {
        action: "ping",
        requestId: 123456
      };
      socket.send(JSON.stringify(msg));
      log("Sent : " + JSON.stringify(msg));
    }

    function isSocketConnected() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        log("Socket ch∆∞a k·∫øt n·ªëi", "error");
        return false;
      }
      return true;
    }

    function showUserId() {
      document.getElementById('userId').innerHTML = G_USER_ID;
    }
    function showRoomId() {
      document.getElementById('roomId').innerHTML = G_ROOM_ID;
    }
    function showGroupId() {
      document.getElementById('groupId').innerHTML = G_GROUP_ID;
    }
    function selectGroupId(groupId) {
      G_GROUP_ID = groupId;
      showGroupId();
    }
    function createButtonsFromJson(jsonArray) {
      const container = document.getElementById('group-id-button-container');

      jsonArray.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item.groupId; 
        btn.name = item.groupId;
        btn.onclick = () => selectGroupId(item.groupId);
        container.appendChild(btn);
      });
    }
    function randomId(length = 8) {
      return Math.random().toString(36).substr(2, length);
    }
    function createUserId(){
      return "user_" + randomId(); 
    }

    document.getElementById("clearBtn").addEventListener("click", () => {
      document.getElementById("log").innerHTML = "";
    });


  function toogleFormatJson(buttonEl) {
    const logEntry = buttonEl.closest(".log-entry");
    if (!logEntry) return;

    const contentEl = logEntry.querySelector(".log-content");
    if (!contentEl) return;

    // L·∫•y text
    const text = contentEl.textContent.trim();

    try {
      const obj = JSON.parse(text);
      // Toggle format
      if (contentEl.dataset.formatted === "true") {
        contentEl.textContent = JSON.stringify(obj);
        contentEl.dataset.formatted = "false";
      } else {
        contentEl.textContent = JSON.stringify(obj, null, 2);
        contentEl.dataset.formatted = "true";
      }
    } catch (err) {
      console.error("Kh√¥ng parse ƒë∆∞·ª£c JSON:", err);
    }
  }

  function copyJsonData(buttonEl) {
      const logEntry = buttonEl.closest(".log-entry");
      if (!logEntry) return;
      const contentEl = logEntry.querySelector(".log-content");
      if (!contentEl) return;

      const text = contentEl.textContent.trim();

      navigator.clipboard.writeText(text)
        .then(() => {
          console.log("ƒê√£ copy JSON:", text);
          alert("JSON ƒë√£ ƒë∆∞·ª£c copy v√†o clipboard!");
        })
        .catch(err => {
          console.error("Kh√¥ng copy ƒë∆∞·ª£c:", err);
        });
    }

    function showPlayerInfos(players) {
      const container = document.getElementById("players-container");
      container.innerHTML = ""; // clear old content

      players.forEach(player => {
        const card = document.createElement("div");
        card.className = "player-card";

        const avatar = document.createElement("img");
        avatar.src = player.avatarUrl;
        avatar.alt = player.name;

        const name = document.createElement("div");
        name.className = "player-name";
        name.textContent = player.name;

        const info = document.createElement("div");
        info.className = "player-info";
        info.innerHTML = `
          Seat: ${player.seatIndex} <br>
          Chips: ${player.chip} <br>
          Balance: ${player.balance} <br>
          role: ${player?.role}
        `;
 
        const handDiv = document.createElement("div");
        handDiv.className = "player-hand";
        if (player.hand && player.hand.length > 0) {
          player.hand.forEach(cardInfo => {
            const cardEl = document.createElement("div");
            cardEl.className = "card";
            cardEl.textContent = `${cardInfo.cardSpriteName} (${cardInfo.rank} ${cardInfo.suit})`;
            handDiv.appendChild(cardEl);
          });
        }

        card.appendChild(avatar);
        card.appendChild(name);
        card.appendChild(info);
        container.appendChild(card);
        card.appendChild(handDiv);
      });
    }

  function updatePlayerInfo(players, updatedInfo) {
    // T√¨m index c·ªßa player theo name
    const index = players.findIndex(p => p.name === updatedInfo.name);

    if (index !== -1) {
      // N·∫øu c√≥ th√¨ update
      players[index] = { ...players[index], ...updatedInfo };
    } else {
      // N·∫øu kh√¥ng c√≥ th√¨ th√™m m·ªõi
      players.push(updatedInfo);
    }

    return players;
  }

  // Remove player theo name
  function removePlayerInfo(players, name) {
    const index = players.findIndex(p => p.name === name);

    if (index !== -1) {
      players.splice(index, 1); // xo√° ph·∫ßn t·ª≠ t·∫°i index
    }

    return players;
  }
  </script>

  <script>
    function showTableCards(cards) {
      const container = document.getElementById("table-container");
      container.innerHTML = "";

      const cardsDiv = document.createElement("div");
      cardsDiv.className = "cards-container";

      cards.forEach(card => {
        const cardItem = document.createElement("div");
        cardItem.className = "card-item";

        const sprite = document.createElement("div");
        sprite.className = "card-sprite";
        sprite.textContent = card.cardSpriteName;

        const info = document.createElement("div");
        info.className = "card-info";
        info.innerHTML = `
          ID: ${card.id}<br>
          Rank: ${card.rank}<br>
          Suit: ${card.suit}
        `;

        cardItem.appendChild(sprite);
        cardItem.appendChild(info);
        cardsDiv.appendChild(cardItem);
      });

      container.appendChild(cardsDiv);
    }

    function updateTableCards(tableCards, updateCard) {
      // T√¨m index c·ªßa player theo name
      const index = tableCards.findIndex(p => p.id === updateCard.id);

      if (index !== -1) {
        // N·∫øu c√≥ th√¨ update
        tableCards[index] = { ...tableCards[index], ...updateCard };
      } else {
        // N·∫øu kh√¥ng c√≥ th√¨ th√™m m·ªõi
        tableCards.push(updateCard);
      }

      return tableCards;
    }
  </script>
</body>
</html>
