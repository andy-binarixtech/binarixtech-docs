<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SICBO GAME</title>
  <link rel="stylesheet" href="./css/main.css">

  <!-- info -->
  <style>
    .info {
      border: 2px solid #6a0dad;
      margin: 5px;
      padding: 5px;
      border-radius: 8px;
      background-color: #f3e8ff;
      font-family: Arial, sans-serif;
    }

    .info title {
      color: #6a0dad; /* ch·ªØ t√≠m */
      font-weight: bold;
    }

    #groupId {
      margin-left: 5px;
      color: #4b0082; /* t√≠m ƒë·∫≠m h∆°n */
    }

    #group-id-button-container button {
      background-color: #6a0dad;
      color: white;
      border: none;
      padding: 8px 12px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #group-id-button-container button:hover {
      background-color: #4b0082;
    }
  </style>

  <style>
    #controls button {
      margin: 5px;
    }

    .action-container {
      display: flex;
      gap: 10px;
      margin: 20px;
    }
    .action-button {
      padding: 8px 14px;
      border: 1px solid #333;
      border-radius: 4px;
      background: #f0f0f0;
      cursor: pointer;
      font-weight: bold;
    }
    .action-button:hover {
      background: #d0eaff;
    }
  </style>

  <style>
    .room-group {
      margin-bottom: 15px;
    }
    .room-group h3 {
      margin: 5px 0;
    }
    .room-button {
      margin: 5px;
      padding: 8px 12px;
      border: 1px solid #333;
      border-radius: 4px;
      background: #f0f0f0;
      cursor: pointer;
    }
    .room-button:hover {
      background: #d0eaff;
    }
  </style>

  <style>
    .cards-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 20px;
    }
    .card-item {
      border: 1px solid #666;
      border-radius: 6px;
      padding: 10px;
      width: 120px;
      text-align: center;
      background: #f9f9f9;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    .card-sprite {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 6px;
    }
    .card-info {
      font-size: 13px;
      color: #333;
    }
  </style>

  <style>
    .player-card {
      height: 200px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      margin: 5px;
      display: inline-table;
      text-align: center;
      background: #f9f9f9;
    }
    .player-card img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
    }
    .player-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .player-info {
      font-size: 14px;
      color: #333;
      margin-bottom: 10px;
    }
    .player-hand {
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .card {
      border: 1px solid #666;
      border-radius: 4px;
      padding: 4px;
      background: #fff;
      font-size: 12px;
    }
  </style>

  <!-- Button Actions -->
  <style>
    .button-container {
      display: none;
    }

    .button-container button {
      background-color: #6a0dad;
      color: white;
      border: none;
      padding: 8px 14px;
      margin: 5px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s, transform 0.2s;
    }

    .button-container button:hover {
      background-color: #4b0082;
      transform: scale(1.05);
    }

    .toggle-btn {
      background-color: #9d61c9;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .toggle-btn:hover {
      background-color: #4b0082;
    }
  </style>


  <!-- main -->
  <style>
    .main {
      padding: 5px;
    }
  </style>
</head>
<body>
  <div class="main">
    <h3>SICBO BOT</h3>
    <button class="toggle-btn" onclick="toggleButtons()">Actions</button>
    <div class="button-container" id="buttonContainer" style="display: none;">
      <button onclick="connect()">Connect</button>
      <button onclick="login()">Login</button>
      <button onclick="login_2()">Login 2</button>
      <button onclick="get_room_types()">get room types</button>
      <button onclick="search_room()">search room</button>
      <button onclick="create_room()">create room</button>
      <button onclick="get_rooms()">get rooms</button>
      <button onclick="join_room(G_ROOM_ID)">Join Room</button>

      <div>
        
        <!-- <button onclick="placeBet('BIG', 100000)">ƒê·∫∑t T√†i 1000</button> -->
        <!-- <button onclick="placeBet('SMALL', 200000)">ƒê·∫∑t X·ªâu 2000</button> -->
      </div>
      <div>
        <button onclick="get_user_info()">get_user_info</button>
        <button onclick="get_table_info()">get table info</button>
        <button onclick="bet_history()">bet_history</button>
        <button onclick="bet_history_for_table()">bet_history_for_table</button>
        <button onclick="rebet()">rebet</button>
        <button onclick="user_info()">user_info</button>
      </div>
      <div>
        <button onclick="ping()">PING</button>
      </div>
      <div>
        <label for="diceInput">Nh·∫≠p k·∫øt qu·∫£ x√∫c x·∫Øc (v√≠ d·ª•: 1,2,3):</label>
        <input type="text" id="diceInput" placeholder="Nh·∫≠p 3 s·ªë t·ª´ 1-6" />
        <button onclick="set_mode('PROD')">set_mode PROD</button>
        <button onclick="set_mode('TEST')">set_mode TEST</button>
      </div>  
    </div>

    <div id="controls">
      <button id="clearBtn">üßπ Clear Log</button>
    </div>

    <div>
      <button onclick="deposit()">deposit</button>
      <!-- ch·ªçn side -->
      <label for="betSide">Ch·ªçn c·ª≠a:</label>
      <select id="betSide">

      </select>

      <!-- nh·∫≠p s·ªë ti·ªÅn -->
      <label for="betAmount">S·ªë ti·ªÅn:</label>
      <input type="number" id="betAmount" value="50000" placeholder="Nh·∫≠p s·ªë ti·ªÅn" />

      <!-- button -->
      <button onclick="placeBet()">ƒê·∫∑t c∆∞·ª£c</button>
    </div>

    <div class="info">
      <di>
        <span class="title">User Id: </span>
        <span id='userId'></span>
      </di>
      <div>
        <span class="title">Room Id: </span>
        <span id='roomId'></span>
      </div>
      <div>
        <span class="title">Group Id: </span>
        <span id='groupId'></span>
        <div id="group-id-button-container"></div>
      </div>
    </div>

    <div id="selectedRoomId"></div>
    <div id="rooms-container"></div>
    <div id="players-container"></div>
    <div id="table-container"></div>
    <div id="actions-container"></div>
    <div id="raise-container"></div>
  
      <!-- <pre id="log"></pre> -->
      <!-- N√∫t toggle -->

      
      <div id="log-wrapper">
        <button class="toggle-log-btn" onclick="toggleLog()">Show/Hide Log</button>
        <div id="log" style="display: none;"></div>
      </div>
    </div>
  <script>
    let socket;
    let G_USER_ID
    let G_GROUP_ID;
    let G_ROOM_ID;
    let G_PLAYER_INFOS = [];
    let G_TABLE_CARDS = [];
    let G_SELECTED_ROOM;
    let G_QUICK = false;
    const zoneName = 'SicboZone';
    const pluginName = 'sicboPlugin';

    function logNative(msg) {
      const timestamp = new Date().toISOString();
      document.getElementById("log").textContent += timestamp + " : " + msg + "\n";
    }

    function log(msg, type="default") {
      const timestamp = new Date().toLocaleString();
      const logContainer = document.getElementById("log");

      const entry = document.createElement("div");
      entry.className = "log-entry";

      const timeCol = document.createElement("div");
      timeCol.className = "log-time";
      timeCol.textContent = timestamp;

      const actionCol = document.createElement("div");
      actionCol.className = "log-action";

      const btnFormat = document.createElement("button");
      btnFormat.textContent = "Toggle JSON";
      btnFormat.onclick = () => toogleFormatJson(btnFormat);

      const btnCopy = document.createElement("button");
      btnCopy.textContent = "Copy";
      btnCopy.onclick = () => copyJsonData(btnCopy);

      const msgCol = document.createElement("div");
      msgCol.className = "log-msg " + type;

      const icon = document.createElement("span");
      icon.className = "log-icon";

      // ch·ªçn icon theo lo·∫°i log
      switch(type) {
        case "sent": icon.textContent = "üì§"; break;
        case "received": icon.textContent = "üì•"; break;
        case "error": icon.textContent = "‚ö†Ô∏è"; break;
        default: icon.textContent = "‚ÑπÔ∏è";
      }

      const text = document.createElement("span");
      text.className = 'log-content';
      text.textContent = msg;

      msgCol.appendChild(icon);
      msgCol.appendChild(text);
      actionCol.appendChild(btnFormat);
      actionCol.appendChild(btnCopy);

      entry.appendChild(timeCol);
      entry.appendChild(actionCol);
      entry.appendChild(msgCol);
      logContainer.appendChild(entry);

      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function connect() {
      // socket = new WebSocket("wss://websocket.bigame.vip/ws1");
      socket = new WebSocket("ws://localhost:8892/websocket");

      socket.onopen = () => {
        log("Connected to server");
        socket.send(JSON.stringify({ action: "join_to_sicbo_game" }));
      };

      socket.onmessage = (event) => {
        log(event.data);
        const response = event.data;
        const jsonResponse = JSON.parse(event.data);
        const idResponse = jsonResponse[0];
        if (idResponse === 1) {
          process_response_1(jsonResponse);
        } else if (idResponse === 3) {
          process_response_3(jsonResponse);
        } else if (idResponse === 5) {
          process_response_5(jsonResponse);
        }
      };

      socket.onclose = () => {
        log("Connection closed");
      };

      socket.onerror = (err) => {
        log("Error: " + err, "error");
      };
    }

    function process_response_5(jsonResponse) {
      const dataResponse = jsonResponse[1];
      const action = dataResponse?.action;
      const eventServer = dataResponse.event;
      if ( (action === 'search_room' && eventServer === 'search_room') 
          || (action === 'create_room' && eventServer === 'create_room') ) {
        const datas = dataResponse?.datas;
        const roomInfo = datas?.roomInfo;
        const roomId = roomInfo?.roomId;
        log("> room id: " + roomId);
        if (roomId) {
          G_ROOM_ID = roomId;
          join_room(roomId);
        }
      }
      if (action === 'get_room_types' && eventServer === 'get_room_types') {
        const datas = dataResponse?.datas;
        const roomTypes = datas?.roomTypes;
        if (roomTypes) {
          createButtonsFromJson(roomTypes);
        }
      }

      if (action === 'room_data' && eventServer === 'room_data') {
        const datas = dataResponse?.datas;
        const playerInfos = datas?.playerInfos;
        G_PLAYER_INFOS = playerInfos;
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }

      if (action === 'user_enter_room' && eventServer === 'user_enter_room') {
        const datas = dataResponse?.datas;
        const playerInfo = datas?.playerInfo;
        updatePlayerInfo(G_PLAYER_INFOS, playerInfo);
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }

      if (action === 'place_bind' && eventServer === 'place_bind') {
        const datas = dataResponse?.datas;
        const playerRoles = datas?.playerRoles;
        updatePlayerRole(G_PLAYER_INFOS, playerRoles);
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }

      if (action === 'deal_hole_cards' && eventServer === 'deal_hole_cards') {
        const datas = dataResponse?.datas;
        const playerInfo = datas?.playerInfo;
        updatePlayerInfo2(G_PLAYER_INFOS, playerInfo);
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }

      if (action === 'deal_flop' && eventServer === 'deal_flop') {
        const datas = dataResponse?.datas;
        const tableCards = datas?.tableCards;
        G_TABLE_CARDS = tableCards;
        console.log(tableCards);
        if (G_TABLE_CARDS) {
          showTableCards(G_TABLE_CARDS);
        }
      }

        if (action === 'deal_turn' && eventServer === 'deal_turn') {
        const datas = dataResponse?.datas;
        const tableCards = datas?.tableCards;
        G_TABLE_CARDS = G_TABLE_CARDS.concat(tableCards);
        console.log(G_TABLE_CARDS);
        if (G_TABLE_CARDS) {
          showTableCards(G_TABLE_CARDS);
        }
      }

        if (action === 'deal_river' && eventServer === 'deal_river') {
        const datas = dataResponse?.datas;
        const tableCards = datas?.tableCards;
        G_TABLE_CARDS = G_TABLE_CARDS.concat(tableCards);
        console.log(G_TABLE_CARDS);
        if (G_TABLE_CARDS) {
          showTableCards(G_TABLE_CARDS);
        }
      }

      if (action === 'user_exit_room' && eventServer === 'user_exit_room') {
        const datas = dataResponse?.datas;
        const playerInfo = datas?.playerInfo;
        removePlayerInfo(G_PLAYER_INFOS, playerInfo?.name);
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }

      if (action === 'get_rooms' && eventServer === 'get_rooms') {
        const datas = dataResponse?.datas;
        const rooms = datas?.rooms;
        if (rooms) {
          createRoomButtons(rooms);
        }
      }

      if (action === 'action_infor' && eventServer === 'action_infor') {
        const datas = dataResponse?.datas;
        const action = datas?.action;
        if (action) {
          createActionButtons(action);
          createRaiseSlider(datas);
        }
      }

      if (action === 'action_response' && eventServer === 'action_response') {
        const datas = dataResponse?.datas;
        const success = datas?.success;
        updatePlayerInfo3(G_PLAYER_INFOS, datas);
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
        clearActionButtons();
      }

      if (action === 'player_result' && eventServer === 'player_result') {
        const datas = dataResponse?.datas;
        const playerResults = datas?.playerResults;
        updatePlayerResult(G_PLAYER_INFOS, playerResults);
        if (G_PLAYER_INFOS) {
          showPlayerInfos(G_PLAYER_INFOS);
        }
      }

      if (action === 'end_game' && eventServer === 'end_game') {
        const datas = dataResponse?.datas;
        clearTable();
        clearRaiseSlider();
        // clearPlayerHand();
      }
    }

    function process_response_1(jsonResponse) {
      const success = jsonResponse[1];
      const userId = jsonResponse[3];
      if (success) {
        G_USER_ID = userId;
        showUserId();
        log("> User login success: " + userId);
        if (G_QUICK) {
          get_room_types();
        }
      }
    }

    function process_response_3(jsonResponse) {
      const success = jsonResponse[1];
      const roomId = jsonResponse[3];
      if (success) {
        G_ROOM_ID = roomId;
        showRoomId();
        log("> join room success: " + roomId);
      }
    }

    function login() {
      if (!isSocketConnected()) {
        return;
      }
      const userId = createUserId();
      const loginMessage = [
        1,
        zoneName,
        "nina", 
        "", 
        {}
      ]

      const msg = loginMessage;
      socket.send(JSON.stringify(msg));
      log("Login message: " + JSON.stringify(msg));
    }

    function login_2() {
      if (!isSocketConnected()) {
        return;
      }
      const userId = createUserId();
      const loginMessage = [
        1,
        zoneName,
        "jin", 
        "pw_123", 
        {}
      ]

      const msg = loginMessage;
      socket.send(JSON.stringify(msg));
      log("Login message: " + JSON.stringify(msg));
    }

    function get_room_types() {
      if (!isSocketConnected()) {
        return;
      }
      const zonePluginMessage = [
        6,
        zoneName,
        pluginName,
        {
          "action": "get_room_types",
          "requestId": generateRequestId(),
          "payload": {}
        }
      ];
      const msg = zonePluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function get_user_info() {
      if (!isSocketConnected()) {
        return;
      }
      const zonePluginMessage = [
        6,
        zoneName,
        pluginName,
        {
          "action": "get_user_info",
          "requestId": generateRequestId()
          // ,
          // "payload": {}
        }
      ];
      const msg = zonePluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function get_table_info() {
      if (!isSocketConnected()) {
        return;
      }
      
      const roomPluginMessage = [
        5,
        zoneName,
        G_ROOM_ID,
        {
          "action": "get_table_info",
          "requestId": generateRequestId(),
          "payload": {}
        }
      ];
      const msg = roomPluginMessage;
      socket.send(JSON.stringify(msg));
      log(JSON.stringify(msg));
    }

    function user_info() {
      if (!isSocketConnected()) {
        return;
      }
      
      const roomPluginMessage = [
        5,
        zoneName,
        G_ROOM_ID,
        {
          "action": "user_info",
          "requestId": generateRequestId(),
          "payload": {}
        }
      ];
      const msg = roomPluginMessage;
      socket.send(JSON.stringify(msg));
      log(JSON.stringify(msg));
    }

    function placeBet() {
      if (!isSocketConnected()) {
        return;
      }

      const side = document.getElementById("betSide").value;
      console.log("Ch·ªçn c·ª≠a: ", side);
      console.log("S·ªë ti·ªÅn: ", document.getElementById("betAmount").value);
      const amount = parseInt(document.getElementById("betAmount").value, 10);
      console.log("S·ªë ti·ªÅn: ", amount);
      if (!amount || amount <= 0) {
        alert("Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!");
        return;
      }

      console.log("ƒê·∫∑t c∆∞·ª£c:", side, amount);

      const roomPluginMessage = [
        5,
        zoneName,
        G_ROOM_ID,
        {
          "action": "place_bet",
          "requestId": generateRequestId(),
          "payload": {
            "side": side,
            "amount": amount
          }
        }
      ];

      const msg = roomPluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent : " + JSON.stringify(msg));
    }

    function bet_history() {
      if (!isSocketConnected()) {
        return;
      }
      const roomPluginMessage = [
        5,
        zoneName,
        G_ROOM_ID,
        {
          "action": "bet_history",
          "requestId": generateRequestId(),
          "payload": {}
        }
      ];
      const msg = roomPluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent : " + JSON.stringify(msg));
    }

    function rebet() {
      if (!isSocketConnected()) {
        return;
      }
      const roomPluginMessage = [
        5,
        zoneName,
        G_ROOM_ID,
        {
          "action": "rebet",
          "requestId": generateRequestId(),
          "payload": {}
        }
      ];
      const msg = roomPluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent : " + JSON.stringify(msg));
    }

    function bet_history_for_table() {
      if (!isSocketConnected()) {
        return;
      }
      const roomPluginMessage = [
        5,
        zoneName,
        G_ROOM_ID,
        {
          "action": "bet_history_for_table",
          "requestId": generateRequestId(),
          "payload": {}
        }
      ];
      const msg = roomPluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent : " + JSON.stringify(msg));
    }

    function deposit() {
      if (!isSocketConnected()) {
        return;
      }
      const zonePluginMessage = [
        6,
        zoneName,
        pluginName,
        {
          "action": "deposit",
          "requestId": generateRequestId(),
          "payload": {
            "amount": 200000
          }
        }
      ];
      const msg = zonePluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function search_room() {
      if (!G_GROUP_ID) {
        alert('Select group id, please');
        return;
      }
      if (!isSocketConnected()) {
        return;
      }
      const zonePluginMessage = [
        6,
        zoneName,
        pluginName,
        {
          "action": "search_room",
          "requestId": generateRequestId(),
          "payload": {
              "groupId": G_GROUP_ID
          }
        }
      ];
      const msg = zonePluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function create_room() {
      if (!G_GROUP_ID) {
        alert('Select group id, please');
        return;
      }
      if (!isSocketConnected()) {
        return;
      }
      const zonePluginMessage = [
        6,
        zoneName,
        pluginName,
        {
          "action": "create_room",
          "payload": {
              "groupId": G_GROUP_ID
          }
        }
      ];
      const msg = zonePluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function get_rooms() {
      if (!isSocketConnected()) {
        return;
      }
      const zonePluginMessage = [
        6,
        zoneName,
        pluginName,
        {
          "action": "get_rooms",
          "payload": {}
        }
      ];
      const msg = zonePluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function join_room(roomId) {
      if (!roomId) {
        alert('Select room, please');
        return;
      }
      if (!isSocketConnected()) {
        return;
      }
      const joinRoomMessage = [
        3, 
        zoneName, 
        roomId, 
        ""
      ]
      const msg = joinRoomMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function ping() {
      if (!isSocketConnected()) {
        return;
      }
      const msg = {
        action: "ping",
        requestId: 123456
      };
      socket.send(JSON.stringify(msg));
      log("Sent : " + JSON.stringify(msg));
    }

    function user_bet(actionId, raiseValue) {
      if (!G_ROOM_ID) {
        alert('Join room, please');
        return;
      }
      if (!isSocketConnected()) {
        return;
      }
      // let raiseValue = 0;
      // raiseValue = (actionId == 'RAISE') ? 2000 : 0;
      const roomPluginMessage = [
        5,
        zoneName,
        G_ROOM_ID,
        {
          "action": "user_bet",
          "payload": {
            "action": actionId,
            "raiseValue": raiseValue
          }
        }
      ];
      const msg = roomPluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent: " + JSON.stringify(msg));
    }

    function isSocketConnected() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        log("Socket ch∆∞a k·∫øt n·ªëi", "error");
        return false;
      }
      return true;
    }

    function showUserId() {
      document.getElementById('userId').innerHTML = G_USER_ID;
    }
    function showRoomId() {
      document.getElementById('roomId').innerHTML = G_ROOM_ID;
    }
    function showGroupId() {
      document.getElementById('groupId').innerHTML = G_GROUP_ID;
    }
    function selectGroupId(groupId) {
      G_GROUP_ID = groupId;
      showGroupId();
    }
    function createButtonsFromJson(jsonArray) {
      const container = document.getElementById('group-id-button-container');

      jsonArray.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item.groupId; 
        btn.name = item.groupId;
        btn.onclick = () => selectGroupId(item.groupId);
        container.appendChild(btn);
      });
    }
    function randomId(length = 8) {
      return Math.random().toString(36).substr(2, length);
    }
    function createUserId(){
      return "user_" + randomId(); 
    }
    function generateRequestId() {
      return crypto.randomUUID();
    }

    document.getElementById("clearBtn").addEventListener("click", () => {
      document.getElementById("log").innerHTML = "";
    });


  function toogleFormatJson(buttonEl) {
    const logEntry = buttonEl.closest(".log-entry");
    if (!logEntry) return;

    const contentEl = logEntry.querySelector(".log-content");
    if (!contentEl) return;

    // L·∫•y text
    const text = contentEl.textContent.trim();

    try {
      const obj = JSON.parse(text);
      // Toggle format
      if (contentEl.dataset.formatted === "true") {
        contentEl.textContent = JSON.stringify(obj);
        contentEl.dataset.formatted = "false";
      } else {
        contentEl.textContent = JSON.stringify(obj, null, 2);
        contentEl.dataset.formatted = "true";
      }
    } catch (err) {
      console.error("Kh√¥ng parse ƒë∆∞·ª£c JSON:", err);
    }
  }

  function copyJsonData(buttonEl) {
      const logEntry = buttonEl.closest(".log-entry");
      if (!logEntry) return;
      const contentEl = logEntry.querySelector(".log-content");
      if (!contentEl) return;

      const text = contentEl.textContent.trim();

      navigator.clipboard.writeText(text)
        .then(() => {
          console.log("ƒê√£ copy JSON:", text);
          alert("JSON ƒë√£ ƒë∆∞·ª£c copy v√†o clipboard!");
        })
        .catch(err => {
          console.error("Kh√¥ng copy ƒë∆∞·ª£c:", err);
        });
    }

    function showPlayerInfos(players) {
      const container = document.getElementById("players-container");
      container.innerHTML = "";

      players.forEach(player => {
        const card = document.createElement("div");
        card.className = "player-card";

        const avatar = document.createElement("img");
        avatar.src = player.avatarUrl;
        avatar.alt = player.name;

        const name = document.createElement("div");
        name.className = "player-name";
        name.textContent = player.name;

        const info = document.createElement("div");
        info.className = "player-info";
        info.innerHTML = `
          Seat: ${player.seatIndex} <br>
          Balance: ${player.balance} <br>
          newBalance: ${player.newBalance} <br>
          role: ${player?.role}
        `;
 
        const handDiv = document.createElement("div");
        handDiv.className = "player-hand";
        if (player.handCards && player.handCards.length > 0) {
          player.handCards.forEach(cardInfo => {
            const cardEl = document.createElement("div");
            cardEl.className = "card";
            cardEl.textContent = `${cardInfo.cardSpriteName} (${cardInfo.rank} ${cardInfo.suit})`;
            handDiv.appendChild(cardEl);
          });
        }

        card.appendChild(avatar);
        card.appendChild(name);
        card.appendChild(info);
        container.appendChild(card);
        card.appendChild(handDiv);
      });
    }

  function updatePlayerInfo(players, updatedInfo) {
    // T√¨m index c·ªßa player theo name
    const index = players.findIndex(p => p.name === updatedInfo.name);

    if (index !== -1) {
      players[index] = { ...players[index], ...updatedInfo };
    } else {
      players.push(updatedInfo);
    }

    return players;
  }

  function updatePlayerInfo3(players, updatedInfo) {
    // T√¨m index c·ªßa player theo name
    const index = players.findIndex(p => p.name === updatedInfo.userId);

    if (index !== -1) {
      players[index].newBalance = updatedInfo.newBalance;
    } else {
      players.push(updatedInfo);
    }

    return players;
  }

  function updatePlayerInfo2(players, updatedInfo) {
    // T√¨m index c·ªßa player theo name
    const index = players.findIndex(p => p.name === updatedInfo.name);

    if (index !== -1) {
      // players[index] = { ...players[index], ...updatedInfo };
      players[index].balance = updatedInfo.balance;
      players[index].newBalance = updatedInfo.newBalance;
      players[index].role = updatedInfo.role;
      players[index].handCards = updatedInfo.handCards;
    } else {
      players.push(updatedInfo);
    }

    return players;
  }

  function updatePlayerResult(players, playerResults) {
    playerResults.forEach(result => {
      const index = players.findIndex(p => p.name === result.userID);
      if (index !== -1) {
        players[index].balance = result.balance;
        players[index].newBalance = result.newBalance;
      }
    });
    return players;
  }

  function updatePlayerRole(players, updatedInfo) {
    updatedInfo.forEach(info => {
      const index = players.findIndex(p => p.name === info.userID);
      players[index].role = info.role;
      players[index].handCards = info.handCards;
      players[index].newBalance = info.newBalance;
    });

    return players;
  }

  // Remove player theo name
  function removePlayerInfo(players, name) {
    const index = players.findIndex(p => p.name === name);

    if (index !== -1) {
      players.splice(index, 1); // xo√° ph·∫ßn t·ª≠ t·∫°i index
    }

    return players;
  }
  </script>

  <script>
    function showTableCards(cards) {
      const container = document.getElementById("table-container");
      container.innerHTML = "";

      const cardsDiv = document.createElement("div");
      cardsDiv.className = "cards-container";

      cards.forEach(card => {
        const cardItem = document.createElement("div");
        cardItem.className = "card-item";

        const sprite = document.createElement("div");
        sprite.className = "card-sprite";
        sprite.textContent = card.cardSpriteName;

        const info = document.createElement("div");
        info.className = "card-info";
        info.innerHTML = `
          ID: ${card.id}<br>
          Rank: ${card.rank}<br>
          Suit: ${card.suit}
        `;

        cardItem.appendChild(sprite);
        cardItem.appendChild(info);
        cardsDiv.appendChild(cardItem);
      });

      container.appendChild(cardsDiv);
    }

    function updateTableCards(tableCards, updateCard) {
      // T√¨m index c·ªßa player theo name
      const index = tableCards.findIndex(p => p.id === updateCard.id);

      if (index !== -1) {
        // N·∫øu c√≥ th√¨ update
        tableCards[index] = { ...tableCards[index], ...updateCard };
      } else {
        // N·∫øu kh√¥ng c√≥ th√¨ th√™m m·ªõi
        tableCards.push(updateCard);
      }

      return tableCards;
    }
  </script>

  <script>
    function selectRoom(roomId) {
      join_room(roomId);
      G_SELECTED_ROOM = roomId;
      showSelectdRoomId(roomId);
      alert("B·∫°n ƒë√£ ch·ªçn room: " + roomId);
    }

    function showSelectdRoomId(roomId) {
      document.getElementById("selectedRoomId").innerText = roomId;
    }

    function createRoomButtons(roomsObj) {
      const container = document.getElementById("rooms-container");
      container.innerHTML = "";

      // Duy·ªát qua t·ª´ng group (key)
      Object.keys(roomsObj).forEach(groupName => {
        const groupDiv = document.createElement("div");
        groupDiv.className = "room-group";

        const title = document.createElement("h3");
        title.textContent = groupName;
        groupDiv.appendChild(title);

        // Duy·ªát qua t·ª´ng roomId trong group
        roomsObj[groupName].forEach(roomId => {
          const btn = document.createElement("button");
          btn.className = "room-button";
          btn.textContent = "Room " + roomId;
          btn.onclick = () => selectRoom(roomId);
          groupDiv.appendChild(btn);
        });

        container.appendChild(groupDiv);
      });
    }
  </script>

  <script>
    function toggleButtons() {
      const container = document.getElementById("buttonContainer");
      container.style.display = container.style.display === "none" ? "block" : "none";
    }
  </script>

  <script>
    function toggleLog() {
      const log = document.getElementById("log");
      log.style.display = log.style.display === "none" ? "block" : "none";
    }
  </script>

  <script>
    const betSides = [
      "BIG","SMALL",
      "LEO1","LEO2","LEO3","LEO4","LEO5","LEO6",
      "ANY_LEO",
      "ODD","EVEN",
      "SUM4","SUM5","SUM6","SUM7","SUM8","SUM9","SUM10","SUM11","SUM12","SUM13","SUM14","SUM15","SUM16","SUM17",
      "DICE1SG","DICE2SG","DICE3SG","DICE4SG","DICE5SG","DICE6SG",
      "DICE1DB","DICE2DB","DICE3DB","DICE4DB","DICE5DB","DICE6DB",
      "DICE12","DICE13","DICE14","DICE15","DICE16",
      "DICE23","DICE24","DICE25","DICE26",
      "DICE34","DICE35","DICE36",
      "DICE45","DICE46","DICE56"
    ];

    // Render dropdown options
    const betSideSelect = document.getElementById("betSide");
    betSides.forEach(side => {
      const option = document.createElement("option");
      option.value = side;
      option.textContent = side;
      betSideSelect.appendChild(option);
    });
  </script>

  <script>
    function set_mode(mode) {
      if (!isSocketConnected()) {
        return;
      }

      const input = document.getElementById("diceInput").value.trim();
      const diceArray = input.split(",").map(num => parseInt(num, 10));

      // Ki·ªÉm tra h·ª£p l·ªá: ph·∫£i c√≥ 3 s·ªë t·ª´ 1-6
      if (diceArray.length !== 3 || diceArray.some(n => isNaN(n) || n < 1 || n > 6)) {
        alert("Vui l√≤ng nh·∫≠p ƒë√∫ng 3 s·ªë t·ª´ 1 ƒë·∫øn 6, v√≠ d·ª•: 2,3,5");
        return;
      }

      console.log("Dice Result ch·ªçn:", diceArray);

      const roomPluginMessage = [
        5,
        zoneName,
        G_ROOM_ID,
        {
          "action": "set_mode",
          "requestId": generateRequestId(),
          "payload": {
            "mode": mode,
            "diceResult": diceArray
          }
        }
      ];
      const msg = roomPluginMessage;
      socket.send(JSON.stringify(msg));
      log("Sent : " + JSON.stringify(msg));
    }
  </script>
</body>
</html>
